<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .select2-container .select2-selection--single { height: 42px; border-radius: 0.5rem; border: 1px solid #d1d5db; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 42px; padding-left: 1rem; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 42px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .slider-marker { position: absolute; top: 50%; transform: translateY(-50%); width: 4px; height: 16px; border-radius: 2px; z-index: 1; }
        .select2-dropdown { z-index: 9999; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 text-gray-800">
    <div class="max-w-full container mx-auto p-4 md:p-8">
        <header class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Dashboard de Análise Preditiva Escolar</h1>
            
            <!-- Conteúdo do cabeçalho que muda dinamicamente -->
            <div id="initial-view-header">
                <p class="text-gray-600 mt-1">Visão geral do impacto de cada variável nas notas de todas as escolas.</p>
            </div>
            <div id="school-view-header" class="hidden">
                 <p class="text-gray-600 mt-1">Selecione uma escola para visualizar as análises de desempenho e similaridade.</p>
                <div class="mt-4">
                    <select id="school-select" class="w-full"></select>
                </div>
            </div>
        </header>

        <!-- Container para o gráfico de resumo inicial -->
        <div id="summary-container" class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold">Análise Geral de Contribuição (SHAP)</h2>
                    <p class="text-sm text-gray-500 mt-1">Impacto de cada variável no resultado do modelo para todas as escolas.</p>
                </div>
                <button id="select-school-btn" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg">Analisar Escola Específica</button>
            </div>
            <p class="text-sm text-gray-500 mb-4 bg-gray-50 p-3 rounded-md">
                Cada ponto representa uma escola. O eixo horizontal mostra como a variável impacta a nota (positivo = aumenta, negativo = diminui). A <span class="font-bold text-red-500">cor vermelha</span> indica um valor alto para a variável naquela escola, enquanto a <span class="font-bold text-blue-500">cor azul</span> indica um valor baixo.
            </p>
            <div id="summary-chart-container" class="relative">
                <div id="summary-loader" class="loader mx-auto my-8"></div>
                <canvas id="summaryShapChart"></canvas>
            </div>
        </div>

        <!-- Container principal do dashboard (inicialmente oculto) -->
        <main id="dashboard-container" class="hidden space-y-8 mt-8">
            <div class="text-right mb-0">
                <button id="back-to-summary-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">← Voltar para Visão Geral</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2">Detalhes da Escola Selecionada</h2>
                    <div id="school-details-content"></div>
                </div>
                <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Análise de Contribuição (SHAP)</h2>
                    <p class="text-sm text-gray-500 mb-2">O que mais influencia a nota desta escola? Valores positivos aumentam a nota, negativos diminuem.</p>
                    <canvas id="shapChart"></canvas>
                </div>
            </div>

            <!-- O resto do seu dashboard continua aqui... -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Escolas Similares (Vizinhança)</h2>
                    <div id="similar-schools-list"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Tabela Comparativa SHAP</h2>
                    <div id="comparison-table-container" class="overflow-x-auto"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Análise Contrafactual (Simulador)</h2>
                        <div id="counterfactual-legend" class="hidden text-sm space-x-4">
                            <span><span class="inline-block w-3 h-3 bg-blue-500 rounded-sm mr-1"></span>Valor Inicial</span>
                            <span><span class="inline-block w-3 h-3 bg-orange-500 rounded-sm mr-1"></span>Valor Comparado</span>
                        </div>
                    </div>

                    <div class="mb-4 space-y-3">
                        <div>
                            <p class="block text-sm font-medium text-gray-700 mb-2">Exibindo variáveis com as <span class="font-bold text-green-600">Maiores Oportunidades de Ganho</span>.</p>
                        </div>
                        <div>
                             <label for="neighbor-select" class="block text-sm font-medium text-gray-700 mb-2">Comparar com Vizinho:</label>
                            <select id="neighbor-select" class="w-full p-2 border border-gray-300 rounded-md" disabled><option>Selecione um vizinho para comparar</option></select>
                        </div>
                    </div>

                    <div id="counterfactual-container" class="mt-4 hidden grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8"></div>
                    
                    <div class="mt-6 bg-gray-50 p-6 rounded-lg">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center items-center">
                            <div><p class="text-sm font-medium text-gray-500">Média Original</p><p id="original-score" class="text-2xl font-bold text-gray-800">--</p></div>
                            <div><p class="text-sm font-medium text-gray-500">Previsão Modelo</p><p id="model-prediction-score" class="text-2xl font-bold text-gray-800">--</p></div>
                            <div id="comparison-score-container" class="hidden"><p class="text-sm font-medium text-gray-500">Média Vizinho</p><p id="comparison-score" class="text-2xl font-bold text-orange-600">--</p></div>
                            <div><p class="text-sm font-medium text-gray-500">Média SIMULADA</p><p id="counterfactual-score" class="text-4xl font-bold text-green-600">--</p></div>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button id="find-hypothetical-button" class="bg-green-600 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg disabled:bg-gray-400" disabled>Buscar escolas com perfil similar</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                     <div id="hypothetical-similar-schools-container" class="hidden h-full">
                        <h3 class="text-xl font-bold mb-4">Escolas Reais com Perfil Similar à Simulação</h3>
                        <div id="hypothetical-similar-schools-list"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';
        let shapChartInstance = null;
        let globalShapChartInstance = null;
        let selectedSchoolId = null;
        let schoolDetails = null;
        let comparisonSchoolDetails = null;
        let topGainFeatures = [];
        let currentTopFeatures = [];
        let modelPrediction = null;
        // --- CORREÇÃO 1: Variável global para armazenar todos os vizinhos ---
        let allNeighborSchools = [];

        // --- Lógica para alternar entre as visualizações ---
        // (Estas funções 'showGeneralView' e 'showSchoolSpecificView' não são usadas,
        // mas podem ser mantidas se você planeja usá-las)
        function showGeneralView() {
            $('#general-view').show();
            $('#school-specific-view').hide();
        }

        function showSchoolSpecificView() {
            $('#general-view').hide();
            $('#school-specific-view').show();
        }
        
        // --- FUNÇÃO REMOVIDA ---
        // A função 'renderGlobalShapPlot' foi removida por ser redundante.
        // A função 'renderSummaryShapChart' já faz este trabalho.
        
        // --- FUNÇÃO REMOVIDA ---
        // A função 'loadGlobalData' foi removida por ser redundante.
        // A função 'loadSummaryData' já faz este trabalho.


        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderSchoolDetails(details) {
            schoolDetails = details;
            $('#school-details-content').html(`<p><strong>Nome:</strong> ${details.NO_ENTIDADE || 'N/D'}</p><p><strong>ID:</strong> ${details.ID_ESCOLA}</p><p><strong>Município:</strong> ${details.NO_MUNICIPIO || 'N/D'} - ${details.SG_UF || 'N/D'}</p><h3 class="text-xl font-semibold mt-4">Média Final Atual: <span class="text-blue-600">${(details.MEDIA_FINAL || 0).toFixed(2)}</span></h3>`);
        }
        
        function renderShapChart(shapData) {
            const ctx = document.getElementById('shapChart').getContext('2d');
            if (shapChartInstance) shapChartInstance.destroy();

            const sortedByAbsolute = [...shapData].sort((a, b) => Math.abs(b.shap_value) - Math.abs(a.shap_value));
            const topShapData = sortedByAbsolute.slice(0, 15).reverse();
            
            const labels = topShapData.map(d => {
                const featureName = d.feature.replace(/_/g, ' ');
                const featureValue = d.feature_value;

                if (featureValue === null || typeof featureValue === 'undefined') {
                    return featureName; // Retorna só o nome se o valor não existir
                }
                
                let displayValue;
                if (featureValue === 0 || featureValue === 1) {
                    displayValue = featureValue; // Para valores binários (sim/não)
                } else {
                    displayValue = `${(featureValue * 100).toFixed(0)}%`; // Para valores percentuais
                }

                return `${featureName} [${displayValue}]`;
            });
            
            const values = topShapData.map(d => d.shap_value);

            shapChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels, 
                    datasets: [{ 
                        data: values, 
                        backgroundColor: values.map(v => v > 0 ? 'rgba(54, 162, 235, 0.6)' : 'rgba(255, 99, 132, 0.6)') 
                    }] 
                }, 
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    plugins: { legend: { display: false } }, 
                    scales: { x: { title: { display: true, text: 'Contribuição para a Nota (SHAP)' } } } 
                } 
            });
        }
        
        function renderSummaryShapChart(data) {
            const ctx = document.getElementById('summaryShapChart').getContext('2d');
            if (globalShapChartInstance) globalShapChartInstance.destroy();

            // Adiciona jitter aos pontos do eixo Y para melhor visualização da densidade
            const jitteredPlotData = data.plot_data.map(p => ({
                x: p.x,
                // Adiciona um pequeno valor aleatório para distribuir os pontos verticalmente
                // O fator 0.4 controla a "largura" do jitter. Ajuste se necessário.
                y: p.y + (Math.random() - 0.5) * 0.8, // y + valor_aleatorio_entre(-0.4, 0.4)
                normalized_value: p.normalized_value,
                school_name: p.school_name
            }));

            const verticalLinePlugin = {
                id: 'verticalLine',
                afterDraw: (chart) => {
                    // ... (código existente, sem mudanças aqui)
                    if (chart.tooltip?._active?.length) return;
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    const x = xAxis.getPixelForValue(0);
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = '#999';
                    ctx.stroke();
                    ctx.restore();
                }
            };

            globalShapChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        // Usamos os dados com jitter aqui
                        data: jitteredPlotData,
                        pointRadius: 2, // Reduzimos o raio do ponto para parecer mais denso
                        pointHoverRadius: 4, // Ajustamos o hover radius também
                        pointBorderWidth: 0,
                        pointBackgroundColor: function(context) {
                            const normalizedValue = context.raw.normalized_value;
                            if (normalizedValue === undefined) return 'rgba(150, 150, 150, 0.7)';
                            const r = 255 * normalizedValue;
                            const b = 255 * (1 - normalizedValue);
                            return `rgba(${Math.round(r)}, 99, ${Math.round(b)}, 0.7)`;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // Certifique-se de que 'y' ainda se refira ao índice original para o nome da feature
                                    const schoolName = context.raw.school_name || 'Escola Desconhecida';
                                    const featureIndex = Math.round(context.raw.y); // Arredonda para pegar o índice da feature
                                    const featureName = data.features[featureIndex].replace(/_/g, ' ');
                                    const shapValue = context.raw.x.toFixed(4);
                                    return [
                                        `Escola: ${schoolName}`,
                                        `Variável: ${featureName}`,
                                        `Impacto (SHAP): ${shapValue}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Impacto na nota da escola (Valor SHAP)' }, grid: { color: '#eee' } },
                        y: { 
                            ticks: { 
                                stepSize: 1, 
                                callback: (value) => {
                                    // Garante que o rótulo seja exibido apenas em valores inteiros para o nome da feature
                                    if (Number.isInteger(value)) {
                                        return data.features[value] ? data.features[value].replace(/_/g, ' ') : '';
                                    }
                                    return ''; // Não exibe rótulo para valores não inteiros
                                }
                            },
                            grid: { display: false } 
                        }
                    }
                },
                plugins: [verticalLinePlugin]
            });
            // O cálculo da altura pode precisar de ajuste, pois o jitter adiciona "espalhamento"
            // Deixei o cálculo original, mas você pode querer um pouco mais de altura se as labels ficarem apertadas.
            $('#summary-chart-container').css('height', `${data.features.length * 40}px`);
        }

        function renderSimilarSchools(schools, containerId) {
            const container = $(`#${containerId}`); container.empty();
            if (schools.length === 0) { container.html('<p class="text-gray-500">Nenhuma escola encontrada.</p>'); return; }
            
            const list = schools.map(school => {
                let detailsHtml = '';
                if (containerId === 'hypothetical-similar-schools-list') {
                    let featuresListHtml = currentTopFeatures.map(feature => {
                        const value = school[feature] || 0;
                        const isBinary = value === 0 || value === 1;
                        const displayValue = isBinary ? value : `${(value * 100).toFixed(0)}%`;
                        const featureNameClean = feature.replace(/_/g, ' ');
                        return `<div class="truncate" title="${featureNameClean}"><span class="font-medium">${featureNameClean}:</span> ${displayValue}</div>`;
                    }).join('');
                    detailsHtml = `<div class="mt-3 pt-3 border-t border-gray-200"><p class="text-xs font-bold text-gray-700 mb-1">Características principais:</p><div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-600">${featuresListHtml}</div></div>`;
                }

                const actionHtml = containerId === 'similar-schools-list' 
                    ? `<button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex-shrink-0" onclick="handleCompareClick(${school.ID_ESCOLA})">Comparar</button>`
                    : `<div class="text-sm text-gray-500 text-right flex-shrink-0">${school.NO_MUNICIPIO || ''} - ${school.SG_UF || ''}</div>`;

                let infoLine = `<p class="text-sm text-gray-500">Média: ${(school.MEDIA_FINAL || 0).toFixed(2)} | ID: ${school.ID_ESCOLA}</p>`;
                if (school.distance !== undefined) {
                    infoLine = `<p class="text-sm text-gray-500">Média: ${(school.MEDIA_FINAL || 0).toFixed(2)} | <span class="font-semibold text-indigo-600">Dissimilaridade: ${school.distance.toFixed(2)}%</span> | ID: ${school.ID_ESCOLA}</p>`;
                }

                return `<div class="p-3 border rounded-lg mb-2"><div class="flex justify-between items-start"><div class="flex-grow pr-4"><p class="font-semibold">${school.NO_ENTIDADE || 'N/D'}</p>${infoLine}</div>${actionHtml}</div>${detailsHtml}</div>`;
            }).join('');
            container.html(list);
        }

        function renderComparisonTable(comparisonData) {
            const container = $('#comparison-table-container'); container.empty();
            let table = `<table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-gray-50"><tr><th class="px-2 py-2 text-left font-medium text-gray-500">Variável</th><th class="px-2 py-2 text-left font-medium text-gray-500">Sua Escola</th><th class="px-2 py-2 text-left font-medium text-gray-500">Vizinho</th><th class="px-2 py-2 text-left font-medium text-gray-500">Diferença</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            comparisonData.sort((a,b) => Math.abs(b.diferenca) - Math.abs(a.diferenca));
            comparisonData.slice(0,10).forEach(row => { table += `<tr><td class="px-2 py-1">${row.feature.replace(/_/g, ' ')}</td><td class="px-2 py-1">${row.shap_escola_1.toFixed(3)}</td><td class="px-2 py-1">${row.shap_escola_2.toFixed(3)}</td><td class="px-2 py-1 font-semibold ${row.diferenca > 0 ? 'text-green-600' : 'text-red-600'}">${row.diferenca.toFixed(3)}</td></tr>`; });
            table += `</tbody></table>`; container.html(table);
        }
        
        function renderCounterfactualControls(featuresToShow) {
            currentTopFeatures = featuresToShow;
            const container = $('#counterfactual-container'); container.empty().show();
            $('#counterfactual-legend').removeClass('hidden');
            $('#original-score').text((schoolDetails.MEDIA_FINAL || 0).toFixed(2));
            $('#model-prediction-score').text((modelPrediction || 0).toFixed(2));
            $('#counterfactual-score').text((modelPrediction || 0).toFixed(2));
            
            featuresToShow.forEach(feature => {
                const originalValue = schoolDetails[feature] || 0;
                const isBinary = originalValue === 0 || originalValue === 1;
                let comparisonMarkerHtml = '';
                if (comparisonSchoolDetails) {
                    const comparisonValue = comparisonSchoolDetails[feature] || 0;
                    comparisonMarkerHtml = `<div class="slider-marker bg-orange-500" style="left: calc(${(comparisonValue * 100)}% - 2px);"></div>`;
                }
                const control = `<div class="p-3 border rounded-lg"><label class="block text-sm font-medium text-gray-700">${feature.replace(/_/g, ' ')}</label><div class="flex items-center mt-2"><div class="relative w-full mr-4 h-5 flex items-center">${comparisonMarkerHtml}<div class="slider-marker bg-blue-500" style="left: calc(${(originalValue * 100)}% - 2px);"></div><input type="range" data-feature="${feature}" min="0" ${isBinary ? 'max="1" step="1"' : 'max="1" step="0.01"'} value="${originalValue}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer relative z-10"></div><span id="value-${feature}" class="font-semibold w-12 text-right">${isBinary ? originalValue : (originalValue * 100).toFixed(0) + '%'}</span></div></div>`;
                container.append(control);
            });
            container.find('input[type="range"]').on('input', handleCounterfactualChange);
        }

        // --- CORREÇÃO 1: Nova função para popular o dropdown de vizinhos ---
        function updateNeighborDropdown() {
            const neighborSelect = $('#neighbor-select');
            const currentSelection = neighborSelect.val(); // Salva a seleção atual, se houver
            neighborSelect.empty().append('<option value="">Selecione para comparar</option>');

            // Usa um Map para garantir que não haja escolas duplicadas pelo ID
            const uniqueSchools = new Map(allNeighborSchools.map(s => [s.ID_ESCOLA, s]));

            uniqueSchools.forEach(s => {
                neighborSelect.append(`<option value="${s.ID_ESCOLA}">${s.NO_ENTIDADE}</option>`);
            });

            neighborSelect.val(currentSelection); // Restaura a seleção anterior, caso ainda exista
        }

        // --- CONTROLE DE LÓGICA E EVENTOS ---
        async function loadSummaryData() {
            try {
                $('#summaryShapChart').hide();
                $('#summary-loader').show();
                const response = await fetch(`${API_BASE_URL}/api/shap_summary`);
                const data = await response.json();
                $('#summary-loader').hide();
                $('#summaryShapChart').show();
                renderSummaryShapChart(data);
            } catch (error) {
                console.error("Erro ao carregar dados do resumo SHAP:", error);
                $('#summary-loader').hide();
                $('#summary-chart-container').html('<p class="text-red-500 text-center">Não foi possível carregar o gráfico de resumo.</p>');
            }
        }

        function switchToSchoolView() {
            $('#summary-container').hide();
            $('#initial-view-header').hide();
            $('#dashboard-container').removeClass('hidden');
            $('#school-view-header').removeClass('hidden');
        }

        // --- CORREÇÃO 2: Garantir que o gráfico global recarregue ---
        function switchToSummaryView() {
            $('#summary-container').show();
            $('#initial-view-header').show();
            $('#dashboard-container').addClass('hidden');
            $('#school-view-header').addClass('hidden');
            $('#school-select').val(null).trigger('change');
            loadSummaryData(); // <-- ADICIONADA ESTA LINHA para recarregar o gráfico
        }

        async function handleSchoolSelect() {
            selectedSchoolId = $('#school-select').val(); if (!selectedSchoolId) return;
            comparisonSchoolDetails = null; 
            $('#comparison-score-container').addClass('hidden');
            $('#find-hypothetical-button').prop('disabled', true);
            if(shapChartInstance) shapChartInstance.destroy();
            
            try {
                const [dashResponse, gainResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/escola_dashboard/${selectedSchoolId}`),
                    fetch(`${API_BASE_URL}/api/ganho_features/${selectedSchoolId}`)
                ]);
                const dashData = await dashResponse.json();
                const gainData = await gainResponse.json();
                
                modelPrediction = dashData.previsao_modelo_original;
                topGainFeatures = gainData.map(item => item.feature);

                // --- CORREÇÃO 1: Popula a lista inicial de vizinhos ---
                allNeighborSchools = [...dashData.escolas_similares];

                renderSchoolDetails(dashData.detalhes_escola);
                renderShapChart(dashData.dados_shap);
                renderSimilarSchools(dashData.escolas_similares, 'similar-schools-list');
                
                // --- CORREÇÃO 1: Usa a nova função para popular o dropdown ---
                updateNeighborDropdown();
                $('#neighbor-select').prop('disabled', false);
                
                renderCounterfactualControls(topGainFeatures);
                $('#comparison-table-container').html('<p class="text-gray-500">Selecione um vizinho para ver a comparação detalhada.</p>');
            } catch (error) { console.error("Erro ao carregar dados:", error); }
        }

        async function handleCompareClick(neighborId) {
            $('#neighbor-select').val(neighborId).trigger('change');
        }
        
        async function handleNeighborSelect() {
            const neighborId = $(this).val();
            if (!neighborId) {
                comparisonSchoolDetails = null;
                $('#comparison-score-container').addClass('hidden');
                $('#comparison-table-container').html('<p class="text-gray-500">Selecione um vizinho para ver a comparação detalhada.</p>');
                renderCounterfactualControls(currentTopFeatures); // Renderiza novamente sem o marcador laranja
                return;
            }
            try {
                const [detailsResponse, shapResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/escola_dashboard/${neighborId}`),
                    fetch(`${API_BASE_URL}/api/comparar_shap/${selectedSchoolId}/${neighborId}`)
                ]);
                const detailsData = await detailsResponse.json();
                const shapData = await shapResponse.json();
                comparisonSchoolDetails = detailsData.detalhes_escola;
                $('#comparison-score').text((comparisonSchoolDetails.MEDIA_FINAL || 0).toFixed(2));
                $('#comparison-score-container').removeClass('hidden');
                renderComparisonTable(shapData);
                renderCounterfactualControls(currentTopFeatures); // Renderiza novamente com o marcador laranja
            } catch (error) { console.error("Erro na comparação:", error); }
        }

        async function handleCounterfactualChange() {
            $('#find-hypothetical-button').prop('disabled', false);
            const features = {};
            $('#counterfactual-container input[type="range"]').each(function() {
                const slider = $(this); const featureName = slider.data('feature'); const value = parseFloat(slider.val());
                features[featureName] = value; const valueSpan = $(`#value-${featureName}`);
                if(slider.attr('step') === '1') { valueSpan.text(value); } else { valueSpan.text((value * 100).toFixed(0) + '%'); }
            });
            try {
                const response = await fetch(`${API_BASE_URL}/api/contrafactual`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ escola_id: selectedSchoolId, features: features }) });
                const data = await response.json();
                $('#counterfactual-score').text(data.media_simulada.toFixed(2));
            } catch (error) { console.error("Falha ao simular:", error); }
        }
        
        async function handleFindHypotheticalSimilar() {
            $('#hypothetical-similar-schools-container').removeClass('hidden');
            $('#hypothetical-similar-schools-list').html('<div class="loader mx-auto"></div>');
            const simulatedFeaturesVector = { ...schoolDetails };
            $('#counterfactual-container input[type="range"]').each(function() {
                simulatedFeaturesVector[$(this).data('feature')] = parseFloat($(this).val());
            });
            try {
                const response = await fetch(`${API_BASE_URL}/api/encontrar_escolas_simuladas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ features: simulatedFeaturesVector, context_features: currentTopFeatures })
                });
                const data = await response.json();
                renderSimilarSchools(data, 'hypothetical-similar-schools-list');
                
                // --- CORREÇÃO 1: Adiciona novas escolas à lista global e atualiza o dropdown ---
                const existingIds = new Set(allNeighborSchools.map(s => s.ID_ESCOLA));
                data.forEach(newSchool => {
                    if (!existingIds.has(newSchool.ID_ESCOLA)) {
                        allNeighborSchools.push(newSchool);
                    }
                });
                updateNeighborDropdown();
                // --- FIM DA CORREÇÃO ---

            } catch (error) { console.error("Erro ao buscar escolas:", error); }
        }
        
        $(document).ready(function() {
            // Inicializa a lista de escolas para o seletor
            (async function init() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/escolas`);
                    const escolas = await response.json();
                    const select = $('#school-select');
                    select.append(new Option('', '')); 
                    escolas.forEach(e => select.append(new Option(`${e.NO_ENTIDADE} (ID: ${e.ID_ESCOLA})`, e.ID_ESCOLA)));
                    select.select2({ placeholder: 'Digite para buscar uma escola...', allowClear: true });
                } catch (error) { console.error("Erro na inicialização:", error); }
            })();

            // Carrega o gráfico de resumo inicial
            loadSummaryData();
            switchToSummaryView();

            // --- LISTENERS DE EVENTOS ---
            $('#school-select').on('change', function() {
                if ($(this).val()) {
                    switchToSchoolView();
                    handleSchoolSelect();
                }
            });
            
            $('#select-school-btn').on('click', function() {
                $('#initial-view-header').hide();
                $('#school-view-header').removeClass('hidden');
                $('#school-select').select2('open');
            });
            
            $('#back-to-summary-btn').on('click', switchToSummaryView);

            $('#neighbor-select').on('change', handleNeighborSelect);
            $('#find-hypothetical-button').on('click', handleFindHypotheticalSimilar);
            
            // Estas duas linhas não parecem estar conectadas a nenhum botão no seu HTML,
            // mas as mantenho caso você as adicione mais tarde.
            $('#show-school-analysis-btn').on('click', showSchoolSpecificView);
            $('#back-to-general-view-btn').on('click', showGeneralView);
        });
    </script>
</body>
</html>
